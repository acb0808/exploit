# timetravel
## 개요
ctf가 끝나면 열리는 플래그를 passcord를 입력해서 얻어야 한다.

## 풀이
iconv를 사용한다는걸 알 수 있는데, 함수 호출시에 방샐하는 범위를 벗어나게 쓰는 것이 가능한 취약점이 존재한다 (CVE-2024-2961)

iconv를 사용하면 3바이트에서 4바이트로 오버플로우가 일어나는 취약점이 존재하고, 이를 이용해서 익스하면 된다.

```php
function safe_iconv($in_charset, $out_charset, $str)
{
	$result = @iconv($in_charset, $out_charset, $str);

	if ($result === false) {
		throw new Exception("iconv conversion failed: Detected an illegal character in input string");
	}
	return $result;
}

$dummy = str_repeat("A", 1098);
try {
	$passcord = safe_iconv("UTF-8", "ISO-2022-CN-EXT", $passcord);
} catch (Exception $e) {
	header("location:index.html");
	echo "redirected";
	exit();
} finally {
	$passcord = iconv("UTF-8", "ISO-2022-CN-EXT", $passcord);
	$passcord_hex = bin2hex($passcord);
	error_log("Passcord: " . $passcord_hex);
	if (strlen($passcord_hex) >= 8) {
		$fourth_byte_hex = substr($passcord_hex, 6, 2);
		$fourth_byte_value = hexdec($fourth_byte_hex);

		if ($fourth_byte_value >= 0x48 && $fourth_byte_value <= 0x4C) {
			header("location:index.html");
			echo "redirected";
			exit();
		} else {
			error_log("OK");
		}
	} else {
		header("location:index.html");
		echo "redirected";
		exit();
	}
	
}
```
safe_iconv를 통해서 검증한 후 iconv를 돌린다.
iconv를 통해서 생긴 4번째 버퍼의 범위가 0x48~0x4C이면 안되고 이를 만족하는 문자는 0x4F(M) 밖에 없다.

湿(젖을 습) 문자를 입력해주면 문제가 풀린다.

추가로 대회 이후 풀으신 분들에게 물어본 결과 다양한 한자가 나왔다.

- 편안할 안(安)
- 꾸짖을 갈(喝) ~~갈!!!~~

![alt](./res/OTwYD4A.png)

☑ cce2024{d82e4e7f1882be6a45b603ad2a552e513f680d2c25547aa3cdcd80f0edbabd4f}